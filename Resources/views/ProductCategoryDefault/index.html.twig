{% extends '@SulmiProductBundle/base.html.twig' %}
{% block title %} {{ 'product.list'|trans }}{{ parent() }}{% endblock %}
{% block stylesheets %}
    {{ parent() }}
{% endblock %}
{% block nav %}
    {{ parent() }} 
{% endblock %}
{% block body %}
    <div class="row">
        <div class="col-xs-4" style="">
            {#        <div class="col-xs-4" style="margin-bottom: 4em;position: fixed;max-width: 300px;">#}
            <div class="row">
                <div class="hide" id="select_node_id"></div>
                <div class="hide" id="select_command_node_id"></div>
                <div class="col-xs-12 hide">
                    <div id="select_node_id_label" class="btn btn-default btn-block" style="text-align: left;">Nie wybrano kategorii</div>
                </div>
                <div class="col-xs-12">
                    <div id="action_add_new_category" class="btn btn-default btn-block" style="text-align: left;"><span class="fa fa-plus-square"></span> Nowa kategoria</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_add_new_category_form" class="btn btn-default btn-block" style="text-align: left;">formularz</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="btn_reset" class="btn btn-default btn-block" style="text-align: left;"><span class="fa fa-refresh"></span> Resetuj wybór</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_edit" class="btn btn-default btn-block" style="text-align: left;"><span class="fa fa-edit"></span> Edytuj</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_edit_form" class="btn btn-default btn-block" style="text-align: left;"></div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_add_product" class="btn btn-default btn-block" style="text-align: left;"><span class="fa fa-edit"></span> Dodaj produkt</div>
                </div>
                <div class="col-xs-12 hide">
                    <div style="max-height: 400px;overflow-y: auto;" id="action_add_product_small_container" class="row"></div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_remove_from_tree" class="btn btn-default btn-block" style="text-align: left;"><span class="fa fa-remove"></span> Usuń tylko</div>
                </div>
                <div class="col-xs-12 hide">
                    <div title="Usuwanie jednej kategorii" id="action_remove_from_tree_dialog"><span class="fa fa-remove"></span> Usuń z drzewa?</div>
                    <div title="Błąd!" id="action_as_sibling_up_dialog"><span class="fa fa-remove"></span> Nie można zmienić chierarchi i przenieść wyżej.</div>
                    <div title="Błąd!" id="action_as_sibling_dialog"><span class="fa fa-remove"></span> Nie można zmienić chierarchi i przenieść niżej.</div>
                </div> 
                <div class="col-xs-12 hide">
                    <div id="action_add_new_subcategory" class="btn btn-default btn-block" style="text-align: left;">Dodaj nowe</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_add_new_subcategory_form" class="btn btn-default btn-block" style="text-align: left;">formularz</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_as_first_child" class="btn btn-default btn-block" style="text-align: left;">Nadkategoria</div>
                </div>
                <div class="col-xs-12 hide">
                    <div id="action_as_sibling" class="btn btn-default btn-block" style="text-align: left;">Sąsiad</div>
                </div>                
                <div class="col-xs-12 hide">
                    <div id="action_as_sibling_up" class="btn btn-default btn-block" style="text-align: left;">Sąsiad na gorze</div>
                </div>                
                <div class="col-xs-12 hide">
                    <div id="select_command_node_label" class="btn btn-default btn-block">Nie wybrano do edycji.</div>
                </div>
            </div>
        </div>
        <div class="col-xs-8">
            <div class="col-xs-12">
                <h1>Productcategories list</h1>
            </div>
            <div class="col-xs-12" id="action_add_product_container" style="max-height: 30em;overflow-y: auto;"></div>
            <div class="col-xs-12" id="navigation-container" style="max-height: 20em;overflow-y: auto;">
                {{ knp_menu_render('SulmiProductBundle:Builder:mainMenu',{'template': '@SulmiProductBundle/menu_admin.html.twig'}) }}
            </div>
        </div>

    {% endblock %}
    {% block footerjavascripts %}
        {{ parent() }}
        <script type="text/javascript">
            $(function () {
                var footer = $(".footer");
                var footerh = footer.outerHeight();
                var footerposition = footer.position();
                footerposition = Math.floor(footerposition.top);
                var navposition = $("#navigation-container");
                var navh = navposition.outerHeight();
                navposition = navposition.position();
                navposition = Math.floor(navposition.top);

                if ((footerposition - navposition) > navh) {
                    var navheight = footerposition - navposition - footerh - 30;
                    console.log(navheight);
                    $('#navigation-container').css({'maxHeight': navheight + 'px'});
                }
                $('div').filter(function () {
                    return this.id.match(/node\-\d+/);
                }).each(function () {
                    newButton(this);
                });

                $('#btn_reset').on("click", null, function (event) {
                    unColorActiveNodes();
                    $('#action_as_first_child').parent().addClass('hide');
                    $('#action_edit')
                        .parent().addClass('hide')
                        .children().first().switchClass('btn-success', 'btn-default');
                    $('#btn_reset').parent().addClass('hide');
                    $('#action_edit_form').parent().addClass('hide');
                    $('#action_as_sibling').parent().addClass('hide');
                    $('#action_as_sibling_up').parent().addClass('hide');
                    $('#action_add_new_subcategory_form').parent().addClass('hide');
                    $('#action_remove_from_tree').parent().addClass('hide');
                    $('#action_add_new_subcategory')
                        .parent().addClass('hide')
                        .children().first().switchClass('btn-success', 'btn-default');
                    $('#action_add_product')
                        .parent().addClass('hide')
                        .children().first().switchClass('btn-success', 'btn-default');
                    $('#action_add_product_container').addClass('hide');
                    $('#action_add_product_small_container').parent().addClass('hide');
                    initButtons();
                    //.children().first().switchClass('btn-success', 'btn-default');
                });

                $('#action_as_sibling').on("click", null, function (event) {
                    event.preventDefault();
                    var rp = getRouteParams();
                    $.ajax({
                        type: 'post',
                        url: '{{ path('sulmi_product_category_index_ajax') }}sibling/' + rp[0] + '/' + rp[1]
                    }).done(function (data) {
                        $('#navigation-container').html(data);
                        initButtons();
                        colorActiveNodes();
                        refreshMenu();
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        $('#action_as_sibling_up_dialog').dialog();
                    });
                });

                $('#action_as_sibling_up').on("click", null, function (event) {
                    event.preventDefault();
                    var rp = getRouteParams();
                    $.ajax({
                        type: 'post',
                        url: '{{ path('sulmi_product_category_index_ajax') }}siblingup/' + rp[0] + '/' + rp[1]
                    }).done(function (data) {
                        $('#navigation-container').html(data);
                        initButtons();
                        colorActiveNodes();
                        refreshMenu();
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        $('#action_as_sibling_up_dialog').dialog();
                    });
                });

                $('#action_as_first_child').on("click", null, function (event) {
                    event.preventDefault();
                    var rp = getRouteParams();
                    $.ajax({
                        type: 'post',
                        url: '{{ path('sulmi_product_category_index_ajax') }}firstchild/' + rp[0] + '/' + rp[1]
                    }).done(function (data) {
                        $('#navigation-container').html(data);

                        refreshMenu();

                        $('div').filter(function () {
                            return this.id.match(/node\-\d+/);
                        }).each(function () {
                            newButton(this);
                            colorActiveNodes();
                        });
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        $('#action_as_sibling_up_dialog').dialog();
                    });
                });

                $('#action_add_new_subcategory').on("click", null, function (event) {
                    event.preventDefault();
                    var rp = getRouteParams();

                    if ($(this).hasClass('btn-default')) {
                        $(this).text('Anuluj dodawanie').switchClass("btn-default", "btn-success");
                        $.ajax({
                            type: 'post',
                            url: '{{ path('sulmi_product_category_index_ajax') }}newsubcategory/' + rp[0]
                        }).done(function (data) {
                            $('#action_add_new_subcategory_form')
                                .html(data)
                                .parent()
                                .removeClass('hide')
                                .find('form').each(function () {
                                newSubCatAjaxFormInit(this);
                            });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            $('#action_as_sibling_up_dialog').dialog();
                        });
                    }
                    else if ($(this).hasClass('btn-success')) {
                        $(this).html('<span class="fa fa-sitemap"></span> <span class="text-success">' + $('#select_node_id_label').text() + '</span> <span class="fa fa-plus-square"></span> Dodaj podkategorię');
                        $(this).switchClass("btn-success", "btn-default");
                        $('#action_add_new_subcategory_form').parent().addClass('hide');
                    }
                });

                $('#action_add_new_category').on("click", null, function (event) {
                    event.preventDefault();
                    if ($(this).hasClass('btn-default')) {
                        $(this).text('Anuluj dodawanie').switchClass("btn-default", "btn-success");
                        $.ajax({
                            type: 'post',
                            url: '{{ path('newcategory_ajax') }}'
                        }).done(function (data) {
                            $('#action_add_new_category_form')
                                .html(data)
                                .parent()
                                .removeClass('hide')
                                .find('form').each(function () {
                                newCatAjaxFormInit(this);
                            });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            $('#action_as_sibling_up_dialog').dialog();
                        });
                    }
                    else if ($(this).hasClass('btn-success')) {
                        $(this).html('<span class="fa fa-plus-square"></span> Nowa kategoria');
                        $(this).switchClass("btn-success", "btn-default");
                        $('#action_add_new_category_form').parent().addClass('hide');
                    }
                });

                $('#action_edit').on("click", null, function (event) {
                    if ($(this).hasClass('btn-default')) {
                        $(this).text('Anuluj edycję').switchClass("btn-default", "btn-success");
                        var rp = getRouteParams();
                        $.ajax({
                            type: 'post',
                            url: '{{ path('sulmi_product_category_index_ajax') }}' + rp[0] + '/edit'
                        }).done(function (data) {
                            $('#action_edit_form')
                                .html(data)
                                .parent()
                                .removeClass('hide')
                                .find('form').each(function () {
                                editCatAjaxFormInit(this);
                            });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            $('#action_as_sibling_up_dialog').dialog();
                        });
                    }
                    else if ($(this).hasClass('btn-success')) {
                        $(this).html('<span class="fa fa-edit"></span> Edytuj');
                        $(this).switchClass("btn-success", "btn-default");
                        $('#action_edit_form').parent().addClass('hide');
                    }
                });

                $('#action_add_product').on("click", null, function (event) {
                    if ($(this).hasClass('btn-default')) {
                        $(this).text('Anuluj dodawanie').switchClass("btn-default", "btn-success");
                        //zaladuj do malego zbiornika
                        var rp = getRouteParams();
                        //------------------------------------------------------
                        $.ajax({
                            type: 'post', ///smallproducts/{id}
                            url: '{{ path('product_index_ajax') }}smallproducts/' + rp[0]
                        }).done(function (data) {
                            $('#action_add_product_small_container')
                                .html(data)
                                .parent()
                                .removeClass('hide');

                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            $('#action_as_sibling_up_dialog').dialog();
                        });
                        //------------------------------------------------------
                        $.ajax({
                            type: 'post',
                            url: '{{ path('product_index_ajax') }}'
                        }).done(function (data) {
                            $('#action_add_product_container')
                                .html(data)
                                .removeClass('hide');
                            // find elems
                            $('div').filter(function () {
                                return this.id.match(/product\-\d+/);
                            }).each(function () {
                                //find in small
                                var id = $(this).attr('id').split('-');
                                id = id[1];
                                var smallproducthtml = $('#productsmall-' + id).html();
                                console.log(smallproducthtml);
                                
                                //if (smallproducthtml.length > 0) {
                                    //$(this).parent().addClass('hide');
                                    //console.log(smallproducthtml);
                                //}
                                $(this).on("click", null, function (event) {
                                    var rp = getRouteParams();
                                    var rpp = getProductRouteParams(this);

                                    $.ajax({
                                        type: 'post',
                                        url: '{{ path('product_index_ajax') }}addproduct/' + rp[0] + '/' + rpp
                                    }).done(function (data) {
                                        $('#action_add_product_small_container')
                                            .html(data)
                                            .parent()
                                            .removeClass('hide');
                                    }).fail(function (jqXHR, textStatus, errorThrown) {
                                        $('#action_as_sibling_up_dialog').dialog();
                                    });
                                });
                                $(this).on("click", null, function (event) {
                                    var rp = getRouteParams();
                                    var rpp = getProductRouteParams(this);

                                    $.ajax({
                                        type: 'post',
                                        url: '{{ path('product_index_ajax') }}addproduct/' + rp[0] + '/' + rpp
                                    }).done(function (data) {
                                        $('#action_add_product_small_container')
                                            .html(data)
                                            .parent()
                                            .removeClass('hide');
                                    }).fail(function (jqXHR, textStatus, errorThrown) {
                                        $('#action_as_sibling_up_dialog').dialog();
                                    });
                                });
                            });

                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            $('#action_as_sibling_up_dialog').dialog();
                        });
                    }
                    else if ($(this).hasClass('btn-success')) {
                        $(this).html('<span class="fa fa-edit"></span> Dodaj produkt');
                        $(this).switchClass("btn-success", "btn-default");
                        $('#action_add_product_container').addClass('hide');
                        $('#action_add_product_small_container').parent().addClass('hide');
                    }
                });

                $('#action_remove_from_tree').on("click", null, function (event) {
                    var rp = getRouteParams();
                    $("#action_remove_from_tree_dialog")
                        .html('Usunąć <strong>' + $("#select_node_id_label").text() + '<strong>?')
                        .dialog({
                            buttons: [{
                                    text: "Usuń",
                                    icons: {primary: "ui-icon-check"},
                                    click: function () {
                                        $.ajax({
                                            type: 'post',
                                            url: '{{ path('sulmi_product_category_index_ajax') }}removefromtree/' + rp[0]
                                        })
                                            .done(function (data) {
                                                $('#navigation-container').html(data);
                                                refreshMenu();
                                                $('#btn_reset').click();
                                            }).fail(function (jqXHR, textStatus, errorThrown) {
                                            $('#action_as_sibling_up_dialog').dialog();
                                        });
                                        $(this).dialog("close");
                                    }
                                },
                                {
                                    text: "Anuluj",
                                    icons: {primary: "ui-icon-close"},
                                    click: function () {
                                        $(this).dialog("close");
                                    }
                                }
                            ]
                        });
                });
            });

            /**
             * 
             * @param {type} btn
             * @return {undefined}
             */
            function newButton(btn) {
                $(btn).off('click').on("click", null, function (event) {
                    if ($(this).hasClass('btn-default')) {
                        $(this).switchClass('btn-default', 'btn-success');
                        $('#select_node_id').html($(this).attr('id'));
                        $('#select_node_id_label').html($(this).text());
                        $('#action_add_new_subcategory')
                            .html('<span class="fa fa-sitemap"></span> <span class="text-success">' + $(this).text() + '</span> <span class="fa fa-plus-square"></span> Dodaj podkategorię')
                            .parent().removeClass('hide');
                        $('#action_edit')
                            .html('<span class="fa fa-edit"></span> Edytuj <span class="text-success">' + $(this).text() + '</span>')
                            .parent().removeClass('hide');
                        $('#action_remove_from_tree')
                            .html('<span class="fa fa-remove"></span> Usuń tylko <span class="text-success">' + $(this).text() + '</span>')
                            .parent().removeClass('hide');
                        $('#action_add_product')
                            .html('<span class="fa fa-plus-square"></span> Produkt do <span class="text-success">' + $(this).text() + '</span>')
                            .parent().removeClass('hide');

                        //if ($('#action_edit_form').html().length > 1 && $('#select_command_node_id').text().length < 1) {
                        //$('#action_edit').switchClass('btn-success', 'btn-default').click();
                        //}

                        $('#btn_reset').parent().removeClass('hide');

                        if ($('#select_node_id').html().length > 1) {
                            $('div').filter(function () {
                                return this.id.match(/node\-\d+/);
                            }).each(function () {
                                if (this.id !== $('#select_node_id').html()) {
                                    $(this).switchClass('btn-success', 'btn-default');
                                    $(this).off('click').on('click', null, function (event) {
                                        $(this).switchClass('btn-default', 'btn-danger');
                                        $('#select_command_node_id').html($(this).attr('id'));
                                        $('#action_as_first_child')
                                            .html('<span class="fa fa-sitemap"> </span> <span class="text-success">' + $('#select_node_id_label').html() + '</span> <span class="fa fa-level-down"></span> <span class="text-danger">' + $(this).text() + '</span>')
                                            .parent().removeClass('hide');
                                        $('#action_as_sibling')
                                            .html('<span class="fa fa-list-ol"></span> <span class="text-success"> ' + $('#select_node_id_label').html() + '</span> <span class="fa fa-long-arrow-down"></span> <span class="text-danger">' + $(this).text() + '</span>')
                                            .parent().removeClass('hide');
                                        $('#action_as_sibling_up')
                                            .html('<span class="fa fa-list-ol"></span> <span class="text-success"> ' + $('#select_node_id_label').html() + '</span> <span class="fa fa-long-arrow-up"></span> <span class="text-danger">' + $(this).text() + '</span>')
                                            .parent().removeClass('hide');
                                        $('div').filter(function () {
                                            return this.id.match(/node\-\d+/);
                                        }).each(function () {
                                            if (this.id !== $('#select_command_node_id').html()) {
                                                $(this).switchClass('btn-danger', 'btn-default');
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    }
                    else if ($(this).hasClass('btn-success')) {
                        $(this).switchClass('btn-success', 'btn-default');
                    }
                });
            }
            function getRouteParams() {
                var rednid = $('#select_command_node_id').html().split('-');
                rednid = rednid[1];
                //console.log(rednid);
                var greenid = $('#select_node_id').html().split('-');
                greenid = greenid[1];
                //console.log(greenid);
                var out = [greenid, rednid];
                return out;
            }
            function getProductRouteParams(product) {
                var id = $(product).attr('id').split('-');
                id = id[1];
                console.log(id);
                return id;
            }
            function colorActiveNodes() {
                if ($('#select_node_id').html().length > 1) {
                    $('#' + $('#select_node_id').html()).switchClass('btn-default', 'btn-success');
                }
                if ($('#select_command_node_id').html().length > 1) {
                    $('#' + $('#select_command_node_id').html()).switchClass('btn-default', 'btn-danger');
                }
            }
            function unColorActiveNodes() {
                if ($('#select_node_id').html().length > 1) {
                    $('#' + $('#select_node_id').html()).switchClass('btn-success', 'btn-default');
                }
                if ($('#select_command_node_id').html().length > 1) {
                    $('#' + $('#select_command_node_id').html()).switchClass('btn-danger', 'btn-default');
                }
            }
            function initButtons() {
                $('div').filter(function () {
                    return this.id.match(/node\-\d+/);
                }).each(function () {
                    $(this).switchClass('btn-success', 'btn-default');
                    $(this).switchClass('btn-danger', 'btn-default');
                    newButton(this);
                });
            }
            function refreshMenu() {
                $.ajax({
                    type: 'post',
                    url: '{{ path('refreshmenu_ajax') }}'
                }).done(function (data) {
                    $('#navleft').children('ul').first().html($(data).html());
                    $('ul.navbar-nav').smartmenus('refresh');
                });
            }
            function newSubCatAjaxFormInit(form) {
                var rp = getRouteParams();
                var options = {
                    target: '#navigation-container',
                    url: '{{ path('sulmi_product_category_index_ajax') }}newsubcategory/' + rp[0],
                    success: function () {
                        $('div').filter(function () {
                            return this.id.match(/node\-\d+/);
                        }).each(function () {
                            newButton(this);
                            colorActiveNodes();
                        });
                        refreshMenu();
                    }
                };

                $(form).ajaxForm(options);
            }
            function newCatAjaxFormInit(form) {
                var options = {
                    target: '#navigation-container',
                    url: '{{ path('newcategory_ajax') }}',
                    success: function () {
                        $('div').filter(function () {
                            return this.id.match(/node\-\d+/);
                        }).each(function () {
                            newButton(this);
                            colorActiveNodes();
                        });
                        refreshMenu();
                    }
                };

                $(form).ajaxForm(options);
            }
            function editCatAjaxFormInit(form) {
                var rp = getRouteParams();
                var options = {
                    target: '#navigation-container',
                    url: '{{ path('sulmi_product_category_index_ajax') }}' + rp[0] + '/edit',
                    success: function () {
                        $('div').filter(function () {
                            return this.id.match(/node\-\d+/);
                        }).each(function () {
                            newButton(this);
                            colorActiveNodes();
                        });
                        refreshMenu();
                    }
                };

                $(form).ajaxForm(options);
            }
        </script>
    {% endblock %}
